# イベント場所・会場情報更新スクリプト

## 概要

イベントテーブルの`location`や`venue`フィールドが空（null、空文字、「今から」）のレコードに対して、Gemini APIを使用してイベントの詳細情報から場所・会場情報を抽出し、自動的に更新するスクリプトです。

## 機能

- イベントのタイトル、説明、会場、住所情報を解析
- Gemini AIを使用して**会場情報**と**場所情報**の両方を抽出
- 信頼度に基づく更新の可否判定
- 既存の会場情報がある場合は保持（空の場合のみ更新）
- レート制限対策（API呼び出し間隔制御）
- ドライランモードでのテスト実行

## 前提条件

1. `GEMINI_API_KEY` 環境変数の設定
2. データベース接続情報（`DATABASE_URL`）の設定

## 使用方法

### 1. ドライランモード（テスト実行）

実際にデータベースを更新せず、抽出結果のみを確認：

```bash
npm run update-locations:dry-run
```

### 2. 本実行モード

実際にデータベースを更新：

```bash
npm run update-locations
```

### 3. TypeScriptでの直接実行

```bash
npx ts-node scripts/update-event-locations.ts --dry-run
npx ts-node scripts/update-event-locations.ts
```

## 抽出される情報

### 会場情報（venue）
- **具体的な施設名**: 渋谷ヒカリエ、東京ビッグサイトなど
- **企業名**: サイバーエージェント、Google Japanなど
- **大学・教育施設**: 東京大学、早稲田大学など
- **オンライン**: オンライン開催の場合

### 場所情報（location）
- **都道府県名**: 東京都、大阪府、神奈川県など
- **市区町村名**: 渋谷区、新宿区、大阪市など  
- **エリア名**: 渋谷、新宿、梅田、天神など
- **オンライン**: オンライン開催のイベント
- **不明**: 場所が特定できない場合

## 設定項目

### 処理対象の条件

以下の条件に該当するイベントが処理対象となります：

- `location` が null、空文字 ("")、または "今から"
- `venue` が null または 空文字 ("")

### 信頼度の閾値

- 最低信頼度: 0.3
- 信頼度がこの値を下回る場合は更新をスキップ

### 処理制限

- デフォルト処理件数: 50件
- API呼び出し間隔: 1秒

## ログ出力例

```
🚀 イベント場所情報更新スクリプト開始
📊 更新対象イベント数: 25件

[1/25] 処理中: React勉強会 in 渋谷
📍 場所抽出中: React勉強会 in 渋谷...
✅ 場所・会場抽出成功: 渋谷ヒカリエ / 東京都渋谷区 (信頼度: 0.9)
💾 更新完了: uuid-123 -> 東京都渋谷区 (会場: 渋谷ヒカリエ)

[2/25] 処理中: オンラインVue.js ワークショップ
📍 場所抽出中: オンラインVue.js ワークショップ...
✅ 場所・会場抽出成功: オンライン / オンライン (信頼度: 0.95)
💾 更新完了: uuid-456 -> オンライン

🏆 処理完了
✅ 成功: 23件
❌ エラー: 2件
```

## エラーハンドリング

- **API制限**: タイムアウト（8秒）とレート制限対策
- **JSON解析エラー**: 不正なレスポンスをスキップ
- **DB接続エラー**: 適切にコネクションを切断
- **低信頼度**: 信頼度0.3未満の結果はスキップ

## 注意事項

1. **API使用量**: Gemini APIの使用料金が発生します
2. **実行時間**: 50件処理で約1-2分程度
3. **データバックアップ**: 本実行前に必要に応じてデータバックアップを実行
4. **環境変数**: `.env`ファイルまたは環境変数でAPIキーを設定

## トラブルシューティング

### よくあるエラー

**GEMINI_API_KEY環境変数が設定されていません**
```bash
export GEMINI_API_KEY="your-api-key-here"
```

**データベース接続エラー**
```bash
export DATABASE_URL="postgresql://..."
```

**タイムアウトエラー**
- ネットワーク環境を確認
- API制限を確認（使用量上限など）